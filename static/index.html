<html>
<head>
    <title>Yestr</title>
</head>

<body>

    <input type="button" value="Connect Metamask" id="connect_metamask_btn"/>
    <span id="ethereum_address"></span>
    <br/>
    <br/>

    <textarea id="content"></textarea>
    <br/>
    <span id="content_event_id"></span>
    <br/>
    <input type="button" value="Sign" id="content_sig_btn"/>
    <br/>

</body>


<script type="module">
import { ethers } from "/static/ethers-5.6.esm.min.js";

const contract_abi = [
    'function mint(bytes memory handle) public',
];

// const contract_address = "";
// const erc20 = new ethers.Contract(address, abi, provider);

const content = document.getElementById('content');
const content_event_id = document.getElementById('content_event_id');
const content_sig_btn = document.getElementById('content_sig_btn');

// function init() {
// }

window.onload = async () => {
    if (typeof window.ethereum !== 'undefined') {
        console.log('MetaMask is installed!');
        if(window.ethereum.isConnected()){
        }else{
            const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
        }

        // const rsp = await fetch(`/get_metadata?wallet=${ethereum.selectedAddress}`);
        // metadata.value = (await rsp.json())['metadata'];
        console.log(ethereum.selectedAddress);
        ethereum_address.innerText = ethereum.selectedAddress;

        connect_metamask_btn.onclick = async (evt) => {
            const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
            const account = accounts[0];
            console.log(account);
            ethereum_address.innerText = account;

            // await ethereum.request({
            //     method: "wallet_addEthereumChain",
            //     params: [{
            //         chainId: "0x13881",
            //         rpcUrls: ["https://endpoints.omniatech.io/v1/matic/mumbai/public"],
            //         chainName: "Mumbai Testnet",
            //         nativeCurrency: {
            //             name: "MATIC",
            //             symbol: "MATIC",
            //             decimals: 18
            //         },
            //         blockExplorerUrls: ["https://mumbai.polygonscan.com"]
            //     }]
            // });

            // await ethereum.request({
            //     method: 'wallet_switchEthereumChain',
            //     params: [{ chainId: '0x13881' }],
            // });
        }

        const provider = new ethers.providers.Web3Provider(window.ethereum);
        const signer = provider.getSigner();
        // const contract = new ethers.Contract(contract_address, contract_abi, signer);

        // handle_mint_btn.onclick = async (evt) => {
        //     const handle = new TextEncoder().encode(handle_mint.value);
        //     await contract.mint(handle);
        // const rsp = await fetch(`/save_metadata?token=${jwt}&wallet=${ethereum.selectedAddress}`, {method:'POST', body: metadata.value});
        // }

        // Create WebSocket connection.
        const socket = new WebSocket("ws://192.168.1.9:8010/relay");

        // Connection opened
        socket.addEventListener("open", (event) => {
            // socket.send("Hello Server!");
        });

        // Listen for messages
        socket.addEventListener("message", (event) => {
            console.log("Message from server ", event.data);
        });

        var event = {};
        var event_id = '';
        var event_sig = '';
        content.addEventListener('keyup', async (evt) => {
            const timestamp = parseInt(Date.now()/1000);
            const json = JSON.stringify([0, ethereum.selectedAddress, timestamp, 1, [], evt.target.value]);
            // console.log(json);
            event_id = ethers.utils.sha256(new TextEncoder().encode(json));
            content_event_id.innerText = event_id;

            event = {
                "id": event_id,
                "pubkey": ethereum.selectedAddress,
                "created_at": timestamp,
                "kind": 1,
                "tags": [],
                "content": evt.target.value,
            }
        });

        content_sig_btn.onclick = async (evt) => {
            // console.log(ethers.utils.hexlify(new TextEncoder().encode(content.value)));
            // const msg = ethers.utils.hexlify(new TextEncoder().encode(content.value));
            const sig = await ethereum.request({
                method: "personal_sign",
                params: [event_id, ethereum.selectedAddress]
            });
            event['sig'] = sig;
            console.log(event);
            socket.send( JSON.stringify(['EVENT', event]) );

        }
    }
}


// init();
</script>
</html>
