<html>
<head>
    <title>Yestr</title>
</head>

<body>

  <input type="button" value="Connect Metamask" id="connect_metamask_btn" />
  <span id="ethereum_address"></span>
  <br/>
  <br/>
  <input type="text" id="profile_name" />
  <br/>
  <textarea id="profile_about"></textarea>
  <br/>
  <input type="text" id="profile_pic_url" />
  <input type="button" value="Save" id="profile_save_btn" />
  <br/>
  <br/>
  <div id="messages"></div>

  <textarea id="content"></textarea>
  <br/>
  <span id="content_event_hash_id"></span>
  <br/>
  <input type="button" value="Sign" id="content_sig_btn"/>
  <br/>

</body>


<script type="module">
import { ethers } from "/static/ethers-5.6.esm.min.js";

const contract_abi = [
    'function mint(bytes memory handle) public',
];

// const contract_address = "";
// const erc20 = new ethers.Contract(address, abi, provider);

const messages = document.getElementById('messages');
const content = document.getElementById('content');
const content_event_hash_id = document.getElementById('content_event_hash_id');
const content_sig_btn = document.getElementById('content_sig_btn');

const profile_name = document.getElementById('profile_name');
const profile_about = document.getElementById('profile_about');
const profile_pic_url = document.getElementById('profile_pic_url');
const profile_save_btn = document.getElementById('profile_save_btn');

window.onload = async () => {
  if (typeof window.ethereum !== 'undefined') {
    console.log('MetaMask is installed!');
    if(window.ethereum.isConnected()){
    }else{
        const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
    }

    console.log(ethereum.selectedAddress);
    ethereum_address.innerText = ethereum.selectedAddress;

    connect_metamask_btn.onclick = async (evt) => {
      const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
      const account = accounts[0];
      console.log(account);
      ethereum_address.innerText = account;

      try {
        await ethereum.request({
          method: "wallet_addEthereumChain",
          params: [{
            chainId: "0x208",
            rpcUrls: ["http://192.168.1.9:9001"],
            chainName: "BitPoW local",
            nativeCurrency: {
              name: "PoW",
              symbol: "POW",
              decimals: 0
            },
            blockExplorerUrls: ["http://192.168.1.9:9001/scan"]
          }]
        });
      } catch (error) {

      }

      await ethereum.request({
        method: 'wallet_switchEthereumChain',
        params: [{ chainId: '0x208' }],
      });
    }

    const provider = new ethers.providers.Web3Provider(window.ethereum);
    const signer = provider.getSigner();
    // const contract = new ethers.Contract(contract_address, contract_abi, signer);

    // handle_mint_btn.onclick = async (evt) => {
    //   const handle = new TextEncoder().encode(handle_mint.value);
    //   await contract.mint(handle);
    //   const rsp = await fetch(`/save_metadata?token=${jwt}&wallet=${ethereum.selectedAddress}`, {method:'POST', body: metadata.value});
    // }

    // Create WebSocket connection.
    // const socket = new WebSocket("wss://relay1.bitpow.org/relay");
    const socket = new WebSocket("ws://192.168.1.9:8010/relay");

    // Connection opened
    socket.addEventListener("open", (event) => {
      const subscription_id = Math.random()*100000000000000000;
      socket.send(JSON.stringify(["REQ", subscription_id, {}]));
    });

    // Listen for messages
    socket.addEventListener("message", (event) => {
      console.log("Message from server ", event.data);
      const e = JSON.parse(event.data);
      if (e[0] != 'EVENT' || e[2]['kind'] != 1) {
        return
      }
      const p = document.createElement('p');
      p.innerHTML = `<div>${e[2]['content']}</div>
        <div>from <span class='user_addr'>${e[2]['pubkey']}</span>
          <button class='user_follow'>Add</button></div>`;
      messages.appendChild(p);
    });

    var event = null;
    var event_hash_id = '';
    var event_sig = '';
    content.addEventListener('keyup', async (evt) => {
      const timestamp = parseInt(Date.now()/1000);
      const json = JSON.stringify([0, ethereum.selectedAddress, timestamp, 1, [], evt.target.value]);
      // console.log(json);
      event_hash_id = ethers.utils.sha256(new TextEncoder().encode(json));
      content_event_hash_id.innerText = event_hash_id;

      event = {
        "id": event_hash_id,
        "pubkey": ethereum.selectedAddress,
        "created_at": timestamp,
        "kind": 1,
        "tags": [],
        "content": evt.target.value,
      }
    });

    content_sig_btn.onclick = async (evt) => {
      if (event && event_hash_id) {
        // console.log(ethers.utils.hexlify(new TextEncoder().encode(content.value)));
        const sig = await ethereum.request({
          method: "personal_sign",
          params: [event_hash_id, ethereum.selectedAddress]
        });
        event['sig'] = sig;
        console.log(event);
        socket.send(JSON.stringify(['EVENT', event]));
      }else{
        content_event_hash_id.innerText = 'empty!'
      }
    }


    profile_save_btn.onclick = async (evt) => {
      console.log(profile_name.value);
      console.log(profile_about.value);
      console.log(profile_pic_url.value);
      const name = profile_name.value;
      const about = profile_about.value;
      const picture = profile_pic_url.value;

      const timestamp = parseInt(Date.now()/1000);
      const json = JSON.stringify([0, ethereum.selectedAddress, timestamp, 0, [], {name: name, about: about, picture: picture}]);
      console.log(json);
      const event_hash = ethers.utils.sha256(new TextEncoder().encode(json));

      const metadata_event = {
        "id": event_hash_id,
        "pubkey": ethereum.selectedAddress,
        "created_at": timestamp,
        "kind": 0,
        "tags": [],
        "content": {name: name, about: about, picture: picture},
      }

      if (name) {
        // console.log(ethers.utils.hexlify(new TextEncoder().encode(content.value)));
        const sig = await ethereum.request({
          method: "personal_sign",
          params: [event_hash, ethereum.selectedAddress]
        });
        metadata_event['sig'] = sig;
        console.log(metadata_event);
        socket.send(JSON.stringify(['EVENT', metadata_event]));
      }else{
        // content_event_hash_id.innerText = 'empty!'
      }
    }


    messages.addEventListener('click', (evt) => {
      if (evt.target.className == 'user_follow'){
        // console.log(evt.target.parentNode);
        console.log(evt.target.parentNode.querySelector('.user_addr'));
      };
    });
  }
}


</script>
</html>
